!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).IoDb={})}(this,(function(e){"use strict";class t{value;next;constructor(e){this.value=e}}class n{_head;_tail;_size;constructor(){this.clear()}push(e){const n=new t(e);this._head?(this._tail.next=n,this._tail=n):(this._head=n,this._tail=n),this._size++}pop(){const e=this._head;if(e)return this._head=this._head.next,this._size--,e.value}clear(){this._head=void 0,this._tail=void 0,this._size=0}get size(){return this._size}*[Symbol.iterator](){let e=this._head;for(;e;)yield e.value,e=e.next}}function o(e){const t=new n;let o=0;const r=async(e,n,r)=>{o++;const i=(async()=>e(...r))();n(i);try{await i}catch{}o--,t.size>0&&t.pop()()},i=(n,...i)=>new Promise((s=>{((n,i,s)=>{t.push(r.bind(void 0,n,i,s)),(async()=>{await Promise.resolve(),o<e&&t.size>0&&t.pop()()})()})(n,s,i)}));return Object.defineProperties(i,{activeCount:{get:()=>o},pendingCount:{get:()=>t.size},clearQueue:{value:()=>{t.clear()}}}),i}const{toString:r,hasOwnProperty:i}=Object.prototype;function s(e,t){return r.call(e).toLowerCase()===`[object ${t}]`}function c(e,t){return i.call(e,t)}function a(e,t,n=!1){return n&&(s(e,"array")&&e.sort(),s(t,"array")&&t.sort()),JSON.stringify(e)===JSON.stringify(t)}function l(){let e,t;const n=new Promise(((n,o)=>(e=n,t=o)));return{resolve:e,reject:t,promise:n}}let u=!1;const f={};function d(e){return function(e,t,n){const{resolve:o,reject:r,promise:i}=l();return m(e,(async()=>{const{store:i,transaction:c}=_(e,t,"readwrite");let a=0;try{if(s(n,"object")){a+=1;await i.put(n)}if(s(n,"array")){for(const e of n){a+=1;await i.put(e)}}await c.complete;o(new O(a))}catch(e){r(e)}})),i}(this.database,this.collection,e)}function h(e){const{resolve:t,reject:n,promise:o}=l();return m(this.database,(()=>{const o=_(this.database,this.collection).store.get(e);o.onsuccess=()=>t(o.result||null),o.onerror=()=>n(o.error)})),o}function p(e){return j.call(this,e,!1)}function b(e,t){return j.call(this,e,t,!0)}function v(e){return g.call(this,e,!1)}function y(e){return g.call(this,e,!0)}function g(e,t){const{promise:n,resolve:o,reject:r}=l();return m(this.database,(async()=>{let n=await j.call(this,e,t);if(n){n=Array.isArray(n)?n:[n];try{const{store:e,transaction:t}=_(this.database,this.collection,"readwrite");for(const t of n)await e.delete(t._id);await t.complete,o(new S(n.length))}catch(e){r(e)}}else o(new S(0))})),n}function _(e,t,n){const o=f[e].db.transaction(t,n);return{store:o.objectStore(t),transaction:o}}function $(e){let t,n,o=!0,r=!0;if(s(e,"object")){let i;return void 0!==e.$lte&&(n=e.$lte,r=!1),void 0!==e.$gte&&(t=e.$gte,o=!1),void 0===n&&void 0!==e.$lt&&(n=e.$lt),void 0===t&&void 0!==e.$gt&&(t=e.$gt),void 0!==t&&void 0===n?i=IDBKeyRange.lowerBound(t,o):void 0!==n&&void 0===t?i=IDBKeyRange.upperBound(n,r):void 0!==t&&void 0!==n&&(i=IDBKeyRange.bound(t,n,o,r)),delete e.$lte,delete e.$gte,delete e.$lt,delete e.$gt,i}}function m(e,t){f[e].db?t():f[e].reqQueue.push(t)}function j(e,t,n){const o=function(e){try{return JSON.parse(JSON.stringify(e))}catch(e){return{}}}(e),r=Object.keys(o),{resolve:i,reject:s,promise:c}=l();return m(this.database,(()=>{const e=[],c=function(e,t){const n={};for(const o of e)if(!o.includes(".")){const e=$(t[o]);if(e){n.key=o,n.range=e;break}}return n}(r,o),a=function(e,t,n,o){const{key:r,range:i}=o,{unique:s,index:c}=n;return i&&(s.includes(r)||c.includes(r))?function(e,t,n,o){return f[e].db.transaction(t).objectStore(t).index(n).openCursor(o,"prev")}(e,t,r,i):function(e,t,n){return f[e].db.transaction(t).objectStore(t).openCursor(n,"prev")}(e,t,i)}(this.database,this.collection,this.indexes,c);a.onerror=s,a.onsuccess=()=>{const s=a.result;if(s)if(e.push(s.value),n)s.continue();else{const c=w(e,r,o,t,n);if(!c)return s.continue();i(c)}else i(n?w(e,r,o,t,n):null)}})),c}function w(e,t,n,o,r){const i=[];for(const o of e){let e=!0;for(const r of t){const t=n[r];if(!x(q(o,r),t)){e=!1;break}}e&&i.push(o)}return r?i:i[0]||null}function x(e,t){let n=Array.isArray(e)?e:[e];if(s(e,"array")&&s(t,"array"))return a(e,t,!0);var o;if(["string","number","boolean","undefined"].includes(typeof(o=t))||s(o,"null")?n=n.filter((e=>e===t)):s(t,"regexp")?n=n.filter((e=>t.test(e))):c(t,"$eq")?n=n.filter((e=>a(e,t.$eq))):c(t,"$ne")?n=n.filter((e=>!a(e,t.$ne))):s(t.$all,"array")?n=n.filter((e=>a(e,t.$all,!0))):s(t.$in,"array")?n=n.filter((e=>t.$in.includes(e))):s(t.$nin,"array")&&(n=n.filter((e=>!t.$nin.includes(e)))),void 0!==t.$lte?n=n.filter((e=>e<=t.$lte)):void 0!==t.$lt&&(n=n.filter((e=>e<t.$lt))),void 0!==t.$gte?n=n.filter((e=>e>=t.$gte)):void 0!==t.$gt&&(n=n.filter((e=>e>t.$gt))),n.length&&s(t.$or,"array")){const e=new Set;for(const o of t.$or)for(const t of n)x(t,o)&&e.add(t);n=[...e]}return!!n.length}function q(e,t){if(e[t])return e[t];let n=e;const o=t.split(".");try{for(const e of o)if(s(n,"array"))if(Number.isInteger(+e))n=n[e];else{const t=n.filter((t=>c(t,e))).map((t=>t[e]));n=t.length?t:void 0}else{if(!s(n,"object"))return;n=n[e]}return n}catch(e){}}function O(e){this.__proto__=null,this.nInserted=e}function S(e){this.__proto__=null,this.nRemoved=e}e.connect=function(e={version:1}){const{name:t,tables:n,version:r=1}=e;if(u||(indexedDB.open("__test",1),u=!0),!f[t]||!f[t].promise){const e=l(),i=o(15),s=e.promise,c=indexedDB.open(t,r);f[t]={db:void 0,tables:n,reqQueue:[],promise:s},s.getCollection=e=>function(e,t){const n=l(),o=n.promise,{primary:r="_id",unique:i=[],index:s=[]}=f[e].tables[t]||{},c={database:{value:e,configurable:!1},collection:{value:t,configurable:!1},indexes:{value:{primary:r,unique:i,index:s},configurable:!1},findById:{value:h,configurable:!1},findOne:{value:p,configurable:!1},find:{value:b,configurable:!1},deleteOne:{value:v,configurable:!1},deleteMany:{value:y,configurable:!1},updateOne:{value:d,configurable:!1},updateMany:{value:d,configurable:!1}};return Object.defineProperties(o,c),f[e].promise.then((()=>n.resolve(Object.defineProperties({__proto__:null},c)))),o}(t,e),s.close=()=>function(e){f[e].promise.then((()=>{f[e].db.close(),f[e].reqQueue=null,f[e].db=void 0,delete f[e]}))}(t),c.onupgradeneeded=()=>function(e,t){for(const n in t){const o=t[n]||{primary:"_id"};if(!e.objectStoreNames.contains(n)){const t=e.createObjectStore(n,{keyPath:o.primary});if(o.unique)for(const e of o.unique)t.createIndex(e,e,{unique:!0});if(o.index)for(const e of o.unique)t.createIndex(e,e,{unique:!1})}}}(c.result,n),c.onsuccess=()=>{f[t].db=c.result;for(const e of f[t].reqQueue)try{i(e)}catch(e){}f[t].reqQueue=null,e.resolve({getCollection:s.getCollection,close:()=>s.close})},c.onerror=()=>e.reject(c.error)}return f[t].promise},Object.defineProperty(e,"__esModule",{value:!0})}));