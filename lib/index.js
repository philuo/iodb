!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).IoDb={})}(this,(function(e){"use strict";class t{value;next;constructor(e){this.value=e}}class n{_head;_tail;_size;constructor(){this.clear()}push(e){const n=new t(e);this._head?(this._tail.next=n,this._tail=n):(this._head=n,this._tail=n),this._size++}pop(){const e=this._head;if(e)return this._head=this._head.next,this._size--,e.value}clear(){this._head=void 0,this._tail=void 0,this._size=0}get size(){return this._size}*[Symbol.iterator](){let e=this._head;for(;e;)yield e.value,e=e.next}}function r(e){const t=new n;let r=0;const i=async(e,n,i)=>{r++;const o=(async()=>e(...i))();n(o);try{await o}catch{}r--,t.size>0&&t.pop()()},o=(n,...o)=>new Promise((s=>{((n,o,s)=>{t.push(i.bind(void 0,n,o,s)),(async()=>{await Promise.resolve(),r<e&&t.size>0&&t.pop()()})()})(n,s,o)}));return Object.defineProperties(o,{activeCount:{get:()=>r},pendingCount:{get:()=>t.size},clearQueue:{value:()=>{t.clear()}}}),o}const{toString:i,hasOwnProperty:o}=Object.prototype;function s(e,t){return i.call(e).toLowerCase()===`[object ${t}]`}function a(e,t){return o.call(e,t)}function c(e,t,n=!1){return n&&(s(e,"array")&&e.sort(),s(t,"array")&&t.sort()),JSON.stringify(e)===JSON.stringify(t)}function l(e){try{return JSON.parse(JSON.stringify(e))}catch(e){return{}}}function u(){let e,t;const n=new Promise(((n,r)=>(e=n,t=r)));return{resolve:e,reject:t,promise:n}}let f=!1;const d={};function h(e){const{primary:t="_id"}=this.indexes;return function(e,t,n,r){const{resolve:i,reject:o,promise:a}=u();return w(e,(async()=>{const{store:a,transaction:c}=$(e,t,"readwrite");let u=0;try{if(s(r,"array")){const e=[];for(let t=r.length-1;t>=0;--t){const i=r[t];if(i&&!e.includes(i[n])){if(s(i.value,"arraybuffer")){await a.put(i.value,i[n])}else{await a.put(l(i),a.keyPath?undefined:i[n])}e.push(i[n]);u+=1}}}else if(s(r,"object")){if(s(r.value,"arraybuffer")){await a.put(r.value,r[n])}else{await a.put(l(r),a.keyPath?undefined:r[n])}u+=1}await c.complete;i(new S(u))}catch(e){o(e)}})),a}(this.database,this.collection,t,e)}function p(e){const{resolve:t,reject:n,promise:r}=u();return w(this.database,(()=>{const r=$(this.database,this.collection).store.get(e);r.onsuccess=()=>t(r.result||null),r.onerror=()=>n(r.error)})),r}function b(e){return j.call(this,e,!1)}function v(e){return j.call(this,e,!0)}function y(e){return _.call(this,e,!1)}function g(e){return _.call(this,e,!0)}function _(e,t){const{promise:n,resolve:r,reject:i}=u();return w(this.database,(async()=>{let n=await j.call(this,e,t);if(n){n=Array.isArray(n)?n:[n];try{const{store:e,transaction:t}=$(this.database,this.collection,"readwrite");for(const t of n)await e.delete(t._id);await t.complete,r(new P(n.length))}catch(e){i(e)}}else r(new P(0))})),n}function $(e,t,n){const r=d[e].db.transaction(t,n);return{store:r.objectStore(t),transaction:r}}function m(e){let t,n,r=!0,i=!0;if(s(e,"object")){let o;return void 0!==e.$lte&&(n=e.$lte,i=!1),void 0!==e.$gte&&(t=e.$gte,r=!1),void 0===n&&void 0!==e.$lt&&(n=e.$lt),void 0===t&&void 0!==e.$gt&&(t=e.$gt),void 0!==t&&void 0===n?o=IDBKeyRange.lowerBound(t,r):void 0!==n&&void 0===t?o=IDBKeyRange.upperBound(n,i):void 0!==t&&void 0!==n&&(o=IDBKeyRange.bound(t,n,r,i)),delete e.$lte,delete e.$gte,delete e.$lt,delete e.$gt,o}}function w(e,t){d[e].db?t():d[e].reqQueue.push(t)}function j(e,t){const n=l(e),r=Object.keys(n),{resolve:i,reject:o,promise:s}=u();return w(this.database,(()=>{const e=[],s=function(e,t){const n={};for(const r of e)if(!r.includes(".")){const e=m(t[r]);if(e){n.key=r,n.range=e;break}}return n}(r,n),a=function(e,t,n,r){const{key:i,range:o}=r,{unique:s,index:a}=n;return o&&(s.includes(i)||a.includes(i))?function(e,t,n,r){return d[e].db.transaction(t).objectStore(t).index(n).openCursor(r,"prev")}(e,t,i,o):function(e,t,n){return d[e].db.transaction(t).objectStore(t).openCursor(n,"prev")}(e,t,o)}(this.database,this.collection,this.indexes,s);a.onerror=o,a.onsuccess=()=>{const o=a.result;if(o)if(e.push(o.value),t)o.continue();else{const s=x(e,r,n,t);if(!s)return o.continue();i(s)}else i(t?x(e,r,n,t):null)}})),s}function x(e,t,n,r){const i=[];for(const r of e){let e=!0;for(const i of t){const t=n[i];if(!q(O(r,i),t)){e=!1;break}}e&&i.push(r)}return r?i:i[0]||null}function q(e,t){let n=Array.isArray(e)?e:[e];if(s(e,"array")&&s(t,"array"))return c(e,t,!0);var r;if(["string","number","boolean","undefined"].includes(typeof(r=t))||s(r,"null")?n=n.filter((e=>e===t)):s(t,"regexp")?n=n.filter((e=>t.test(e))):a(t,"$eq")?n=n.filter((e=>c(e,t.$eq))):a(t,"$ne")?n=n.filter((e=>!c(e,t.$ne))):s(t.$all,"array")?n=n.filter((e=>c(e,t.$all,!0))):s(t.$in,"array")?n=n.filter((e=>t.$in.includes(e))):s(t.$nin,"array")&&(n=n.filter((e=>!t.$nin.includes(e)))),void 0!==t.$lte?n=n.filter((e=>e<=t.$lte)):void 0!==t.$lt&&(n=n.filter((e=>e<t.$lt))),void 0!==t.$gte?n=n.filter((e=>e>=t.$gte)):void 0!==t.$gt&&(n=n.filter((e=>e>t.$gt))),n.length&&s(t.$or,"array")){const e=new Set;for(const r of t.$or)for(const t of n)q(t,r)&&e.add(t);n=[...e]}return!!n.length}function O(e,t){if(e[t])return e[t];let n=e;const r=t.split(".");try{for(const e of r)if(s(n,"array"))if(Number.isInteger(+e))n=n[e];else{const t=n.filter((t=>a(t,e))).map((t=>t[e]));n=t.length?t:void 0}else{if(!s(n,"object"))return;n=n[e]}return n}catch(e){}}function S(e){this.__proto__=null,this.nInserted=e}function P(e){this.__proto__=null,this.nRemoved=e}e.connect=function(e={version:1}){const{name:t,tables:n,version:i=1}=e;if(f||(indexedDB.open("__test",1),f=!0),!d[t]||!d[t].promise){const e=u(),o=r(15),s=e.promise,a=indexedDB.open(t,i);d[t]={db:void 0,tables:n,reqQueue:[],promise:s},s.getCollection=e=>function(e,t){const n=u(),r=n.promise,{primary:i="_id",unique:o=[],index:s=[]}=d[e].tables[t]||{},a={database:{value:e,configurable:!1},collection:{value:t,configurable:!1},indexes:{value:{primary:i,unique:o,index:s},configurable:!1},findById:{value:p,configurable:!1},findOne:{value:b,configurable:!1},find:{value:v,configurable:!1},deleteOne:{value:y,configurable:!1},deleteMany:{value:g,configurable:!1},updateOne:{value:h,configurable:!1},updateMany:{value:h,configurable:!1}};return Object.defineProperties(r,a),d[e].promise.then((()=>n.resolve(Object.defineProperties({__proto__:null},a)))),r}(t,e),s.close=()=>function(e){d[e].promise.then((()=>{d[e].db.close(),d[e].reqQueue=null,d[e].db=void 0,delete d[e]}))}(t),a.onupgradeneeded=()=>function(e,t){for(const n in t){const r=t[n]||{primary:"_id"};if(!e.objectStoreNames.contains(n)){const t=e.createObjectStore(n,{keyPath:r.primary});if(r.unique)for(const e of r.unique)t.createIndex(e,e,{unique:!0});if(r.index)for(const e of r.unique)t.createIndex(e,e,{unique:!1})}}}(a.result,n),a.onsuccess=()=>{d[t].db=a.result;for(const e of d[t].reqQueue)try{o(e)}catch(e){}d[t].reqQueue=null,e.resolve({getCollection:s.getCollection,close:()=>s.close})},a.onerror=()=>e.reject(a.error)}return d[t].promise},Object.defineProperty(e,"__esModule",{value:!0})}));