!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).IoDb={})}(this,(function(e){"use strict";class t{value;next;constructor(e){this.value=e}}class n{_head;_tail;_size;constructor(){this.clear()}push(e){const n=new t(e);this._head?(this._tail.next=n,this._tail=n):(this._head=n,this._tail=n),this._size++}pop(){const e=this._head;if(e)return this._head=this._head.next,this._size--,e.value}clear(){this._head=void 0,this._tail=void 0,this._size=0}get size(){return this._size}*[Symbol.iterator](){let e=this._head;for(;e;)yield e.value,e=e.next}}function r(e){const t=new n;let r=0;const o=async(e,n,o)=>{r++;const i=(async()=>e(...o))();n(i);try{await i}catch{}r--,t.size>0&&t.pop()()},i=(n,...i)=>new Promise((s=>{((n,i,s)=>{t.push(o.bind(void 0,n,i,s)),(async()=>{await Promise.resolve(),r<e&&t.size>0&&t.pop()()})()})(n,s,i)}));return Object.defineProperties(i,{activeCount:{get:()=>r},pendingCount:{get:()=>t.size},clearQueue:{value:()=>{t.clear()}}}),i}const{toString:o,hasOwnProperty:i}=Object.prototype;function s(e,t){return o.call(e).toLowerCase()===`[object ${t}]`}function c(e,t){return i.call(e,t)}function a(e,t,n=!1){return n&&(s(e,"array")&&e.sort(),s(t,"array")&&t.sort()),JSON.stringify(e)===JSON.stringify(t)}function l(){let e,t;const n=new Promise(((n,r)=>(e=n,t=r)));return{resolve:e,reject:t,promise:n}}let u=!1;const f={};function d(e){return function(e,t,n){const{resolve:r,reject:o,promise:i}=l();return m(e,(async()=>{const{store:i,transaction:c}=_(e,t,"readwrite");let a=0;try{if(s(n,"object")){a+=1;await i.put(n)}if(s(n,"array")){for(const e of n){a+=1;await i.put(e)}}await c.complete;r(new O(a))}catch(e){o(e)}})),i}(this.database,this.collection,e)}function h(e){const{resolve:t,reject:n,promise:r}=l();return m(this.database,(()=>{const r=_(this.database,this.collection).store.get(e);r.onsuccess=()=>t(r.result||null),r.onerror=()=>n(r.error)})),r}function p(e){return j.call(this,e,!1)}function b(e,t){return j.call(this,e,t,!0)}function v(e){return g.call(this,e,!1)}function y(e){return g.call(this,e,!0)}function g(e,t){const{promise:n,resolve:r,reject:o}=l();return m(this.database,(async()=>{let n=await j.call(this,e,t);if(n){n=Array.isArray(n)?n:[n];try{const{store:e,transaction:t}=_(this.database,this.collection,"readwrite");for(const t of n)await e.delete(t._id);await t.complete,r(new S(n.length))}catch(e){o(e)}}else r(new S(0))})),n}function _(e,t,n){const r=f[e].db.transaction(t,n);return{store:r.objectStore(t),transaction:r}}function $(e){let t,n,r=!0,o=!0;if(s(e,"object")){let i;return void 0!==e.$lte&&(n=e.$lte,o=!1),void 0!==e.$gte&&(t=e.$gte,r=!1),void 0===n&&void 0!==e.$lt&&(n=e.$lt),void 0===t&&void 0!==e.$gt&&(t=e.$gt),void 0!==t&&void 0===n?i=IDBKeyRange.lowerBound(t,r):void 0!==n&&void 0===t?i=IDBKeyRange.upperBound(n,o):void 0!==t&&void 0!==n&&(i=IDBKeyRange.bound(t,n,r,o)),delete e.$lte,delete e.$gte,delete e.$lt,delete e.$gt,i}}function m(e,t){f[e].db?t():f[e].reqQueue.push(t)}function j(e,t,n){const r=function(e){try{return JSON.parse(JSON.stringify(e))}catch(e){return{}}}(e),o=Object.keys(r);if(1===o.length&&o[0]===this.indexes.primary&&(s(r[o[0]],"string")||s(r[o[0]],"number")))return h.call(this,r[o[0]]);const{resolve:i,reject:c,promise:a}=l();return m(this.database,(()=>{const e=[],s=function(e,t){const n={};for(const r of e)if(!r.includes(".")){const e=$(t[r]);if(e){n.key=r,n.range=e;break}}return n}(o,r),a=function(e,t,n,r){const{key:o,range:i}=r,{unique:s,index:c}=n;return i&&(s.includes(o)||c.includes(o))?function(e,t,n,r){return f[e].db.transaction(t).objectStore(t).index(n).openCursor(r,"prev")}(e,t,o,i):function(e,t,n){return f[e].db.transaction(t).objectStore(t).openCursor(n,"prev")}(e,t,i)}(this.database,this.collection,this.indexes,s);a.onerror=c,a.onsuccess=()=>{const s=a.result;if(s)if(e.push(s.value),n)s.continue();else{const c=w(e,o,r,t,n);if(!c)return s.continue();i(c)}else i(w(e,o,r,t,n))}})),a}function w(e,t,n,r,o){const i=[];for(const r of e){let e=!0;for(const o of t){const t=n[o];if(!x(q(r,o),t)){e=!1;break}}e&&i.push(r)}return o?i.length?i:null:i[0]||null}function x(e,t){let n=Array.isArray(e)?e:[e];if(s(e,"array")&&s(t,"array"))return a(e,t,!0);var r;if(["string","number","boolean","undefined"].includes(typeof(r=t))||s(r,"null")?n=n.filter((e=>e===t)):s(t,"regexp")?n=n.filter((e=>t.test(e))):c(t,"$eq")?n=n.filter((e=>a(e,t.$eq))):c(t,"$ne")?n=n.filter((e=>!a(e,t.$ne))):s(t.$all,"array")?n=n.filter((e=>a(e,t.$all,!0))):s(t.$in,"array")?n=n.filter((e=>t.$in.includes(e))):s(t.$nin,"array")&&(n=n.filter((e=>!t.$nin.includes(e)))),void 0!==t.$lte?n=n.filter((e=>e<=t.$lte)):void 0!==t.$lt&&(n=n.filter((e=>e<t.$lt))),void 0!==t.$gte?n=n.filter((e=>e>=t.$gte)):void 0!==t.$gt&&(n=n.filter((e=>e>t.$gt))),n.length&&s(t.$or,"array")){const e=new Set;for(const r of t.$or)for(const t of n)x(t,r)&&e.add(t);n=[...e]}return!!n.length}function q(e,t){if(e[t])return e[t];let n=e;const r=t.split(".");try{for(const e of r)if(s(n,"array"))if(Number.isInteger(+e))n=n[e];else{const t=n.filter((t=>c(t,e))).map((t=>t[e]));n=t.length?t:void 0}else{if(!s(n,"object"))return;n=n[e]}return n}catch(e){}}function O(e){this.__proto__=null,this.nInserted=e}function S(e){this.__proto__=null,this.nRemoved=e}e.connect=function(e={version:1}){const{name:t,tables:n,version:o=1}=e;if(u||(indexedDB.open("__test",1),u=!0),!f[t]||!f[t].promise){const e=l(),i=r(15),s=e.promise,c=indexedDB.open(t,o);f[t]={db:void 0,tables:n,reqQueue:[],promise:s},s.getCollection=e=>function(e,t){const n=l(),r=n.promise,{primary:o="_id",unique:i=[],index:s=[]}=f[e].tables[t]||{},c={database:{value:e,configurable:!1},collection:{value:t,configurable:!1},indexes:{value:{primary:o,unique:i,index:s},configurable:!1},findById:{value:h,configurable:!1},findOne:{value:p,configurable:!1},find:{value:b,configurable:!1},deleteOne:{value:v,configurable:!1},deleteMany:{value:y,configurable:!1},updateOne:{value:d,configurable:!1},updateMany:{value:d,configurable:!1}};return Object.defineProperties(r,c),f[e].promise.then((()=>n.resolve(Object.defineProperties({__proto__:null},c)))),r}(t,e),s.close=()=>function(e){f[e].promise.then((()=>{f[e].db.close(),f[e].reqQueue=null,f[e].db=void 0,delete f[e]}))}(t),c.onupgradeneeded=()=>function(e,t){for(const n in t){const r=t[n]||{primary:"_id"};if(!e.objectStoreNames.contains(n)){const t=e.createObjectStore(n,{keyPath:r.primary});if(r.unique)for(const e of r.unique)t.createIndex(e,e,{unique:!0});if(r.index)for(const e of r.unique)t.createIndex(e,e,{unique:!1})}}}(c.result,n),c.onsuccess=()=>{f[t].db=c.result;for(const e of f[t].reqQueue)try{i(e)}catch(e){}f[t].reqQueue=null,e.resolve({getCollection:s.getCollection,close:()=>s.close})},c.onerror=()=>e.reject(c.error)}return f[t].promise},Object.defineProperty(e,"__esModule",{value:!0})}));