{"version":3,"file":"index.js","sources":["../node_modules/oker-limit/oker-queue.js","../node_modules/oker-limit/limit.js","../index.js"],"sourcesContent":["class OkerNode {\n\tvalue;\n\tnext;\n\n\tconstructor(value) {\n\t\tthis.value = value;\n\t}\n}\n\nexport class OkerQueue {\n\t_head;\n\t_tail;\n\t_size;\n\n\tconstructor() {\n\t\tthis.clear();\n\t}\n\n\tpush(value) {\n\t\tconst node = new OkerNode(value);\n\n\t\tif (this._head) {\n\t\t\tthis._tail.next = node;\n\t\t\tthis._tail = node;\n\t\t}\n        else {\n\t\t\tthis._head = node;\n\t\t\tthis._tail = node;\n\t\t}\n\n\t\tthis._size++;\n\t}\n\n\tpop() {\n\t\tconst current = this._head;\n\n\t\tif (!current) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._head = this._head.next;\n\t\tthis._size--;\n\t\treturn current.value;\n\t}\n\n\tclear() {\n\t\tthis._head = undefined;\n\t\tthis._tail = undefined;\n\t\tthis._size = 0;\n\t}\n\n\tget size() {\n\t\treturn this._size;\n\t}\n\n\t* [Symbol.iterator]() {\n\t\tlet current = this._head;\n\n\t\twhile (current) {\n\t\t\tyield current.value;\n\t\t\tcurrent = current.next;\n\t\t}\n\t}\n}\n","import { OkerQueue } from './oker-queue';\n\nexport function OkerLimit (concurrency) {\n\tconst queue = new OkerQueue();\n\tlet activeCount = 0;\n\n\tconst next = () => {\n\t\tactiveCount--;\n\n\t\tif (queue.size > 0) {\n\t\t\tqueue.pop()();\n\t\t}\n\t};\n\n\tconst run = async (fn, resolve, args) => {\n\t\tactiveCount++;\n\n\t\tconst result = (async () => fn(...args))();\n\n\t\tresolve(result);\n\n\t\ttry {\n\t\t\tawait result;\n\t\t} catch {}\n\n\t\tnext();\n\t};\n\n\tconst enqueue = (fn, resolve, args) => {\n\t\tqueue.push(run.bind(undefined, fn, resolve, args));\n\n\t\t(async () => {\n\t\t\tawait Promise.resolve();\n\n\t\t\tif (activeCount < concurrency && queue.size > 0) {\n\t\t\t\tqueue.pop()();\n\t\t\t}\n\t\t})();\n\t};\n\n\tconst generator = (fn, ...args) => new Promise(resolve => {\n\t\tenqueue(fn, resolve, args);\n\t});\n\n\tObject.defineProperties(generator, {\n\t\tactiveCount: {\n\t\t\tget: () => activeCount,\n\t\t},\n\t\tpendingCount: {\n\t\t\tget: () => queue.size,\n\t\t},\n\t\tclearQueue: {\n\t\t\tvalue: () => {\n\t\t\t\tqueue.clear();\n\t\t\t}\n\t\t},\n\t});\n\n\treturn generator;\n}\n","/**\n * @file iodb库\n * @date 2022-07-25\n * @author Perfumere\n */\n\nimport { OkerLimit } from 'oker-limit';\n\nconst { toString, hasOwnProperty } = Object.prototype;\n\nfunction _type(target, typ) {\n    return toString.call(target).toLowerCase() === `[object ${typ}]`;\n}\n\nfunction _odiType(target) {\n    return ['string', 'number', 'boolean', 'undefined'].includes(typeof target) || _type(target, 'null');\n}\n\nfunction _hasProp(target, key) {\n    return hasOwnProperty.call(target, key);\n}\n\nfunction _eq(target, other, loosen = false) {\n    if (loosen) {\n        _type(target, 'array') && target.sort();\n        _type(other, 'array') && other.sort();\n    }\n\n    return JSON.stringify(target) === JSON.stringify(other);\n}\n\nfunction _clone(target) {\n    try { return JSON.parse(JSON.stringify(target)); } catch (err) { return {}; }\n}\n\n/**\n * unwrap promise\n */\nfunction _signal() {\n    let resolve, reject;\n    const promise = new Promise((r, e) => (resolve = r, reject = e));\n\n    return { resolve, reject, promise };\n}\n\nlet fixedIOSbug = false;\nconst dbPool = {};\n\n/**\n * 获取indexedDB链接实例\n * @param opts.name 数据库名\n * @param opts.version 版本\n * @returns IDBDatabase\n */\nexport function connect(opts = { version: 1 }) {\n    const { name, tables, version = 1 } = opts;\n\n    if (!fixedIOSbug) {\n        /**\n         * [fix webkit bug](https://bugs.webkit.org/show_bug.cgi?id=226547)\n         */\n        indexedDB.open('__test', 1);\n        fixedIOSbug = true;\n    }\n\n    if (!dbPool[name] || !dbPool[name].promise) {\n        const signalCtrl = _signal();\n        const limit = OkerLimit(15);\n        const promise = signalCtrl.promise;\n        const idbReq = indexedDB.open(name, version);\n\n        dbPool[name] = { db: undefined, tables, reqQueue: [], promise };\n        promise.getCollection = (tname) => collection(name, tname);\n        promise.close = () => close(name);\n\n        idbReq.onupgradeneeded = () => _createTables(idbReq.result, tables);\n        idbReq.onsuccess = () => {\n            dbPool[name].db = idbReq.result;\n\n            // process cached request\n            for (const request of dbPool[name].reqQueue) {\n                try { limit(request); }\n                catch (err) { /* None */ }\n            }\n\n            dbPool[name].reqQueue = null;\n            signalCtrl.resolve({\n                getCollection: promise.getCollection,\n                close: () => promise.close\n            });\n        };\n        idbReq.onerror = () => signalCtrl.reject(idbReq.error);\n    }\n\n    return dbPool[name].promise;\n}\n\n/**\n * 获取指定表\n */\nfunction collection(name, tname) {\n    const signalCtrl = _signal();\n    const promise = signalCtrl.promise;\n    const { primary = '_id', unique = [], index = [] } = dbPool[name].tables[tname] || {};\n    const handlers = {\n        /** Props */\n        database: { value: name, configurable: false },\n        collection: { value: tname, configurable: false },\n        indexes: { value: { primary, unique, index }, configurable: false },\n        /** Methods */\n        findById: { value: findById, configurable: false },\n        findOne: { value: findOne, configurable: false },\n        find: { value: find, configurable: false },\n        deleteOne: { value: deleteOne, configurable: false },\n        deleteMany: { value: deleteMany, configurable: false },\n        updateOne: { value: insert, configurable: false },\n        updateMany: { value: insert, configurable: false }\n    };\n\n    Object.defineProperties(promise, handlers);\n\n    dbPool[name].promise.then(\n        () => signalCtrl.resolve(Object.defineProperties({ __proto__: null }, handlers))\n    );\n\n    return promise;\n}\n\n/**\n * 关闭指定数据库\n */\nfunction close(name) {\n    dbPool[name].promise.then(() => {\n        dbPool[name].db.close();\n        dbPool[name].reqQueue = null;\n        dbPool[name].db = undefined;\n\n        delete dbPool[name];\n    });\n}\n\n/**\n * 新增一条记录\n * @param tname 表名\n * @param data 数据\n */\nfunction insert(data) {\n    const { primary = '_id' } = this.indexes;\n    return _insert(this.database, this.collection, primary, data);\n}\n\nfunction findById(_id) {\n    const { resolve, reject, promise } = _signal();\n\n    const request = () => {\n        const req = _getStore(this.database, this.collection).store.get(_id);\n        req.onsuccess = () => resolve(req.result || null);\n        req.onerror = () => reject(req.error);\n    };\n\n    _addTask(this.database, request);\n\n    return promise;\n}\n\nfunction findOne(search) {\n    return _find.call(this, search, false);\n}\n\nfunction find(search, opts) {\n    return _find.call(this, search, opts, true);\n}\n\nfunction deleteOne(search) {\n    return _delete.call(this, search, false);\n}\n\nfunction deleteMany(search) {\n    return _delete.call(this, search, true);\n}\n\nfunction _delete(search, removeMany) {\n    const { promise, resolve, reject } = _signal();\n\n    const request = async () => {\n        let matched = await _find.call(this, search, removeMany);\n\n        if (!matched) {\n            resolve(new RemoveResult(0));\n        }\n        else {\n            matched = (Array.isArray(matched) ? matched : [matched]);\n\n            try {\n                const { store, transaction } = _getStore(this.database, this.collection, 'readwrite');\n\n                for (const item of matched) {\n                    await store.delete(item._id);\n                }\n\n                await transaction.complete;\n\n                resolve(new RemoveResult(matched.length));\n            }\n            catch (err) { reject(err); }\n        }\n    };\n\n    _addTask(this.database, request);\n\n    return promise;\n}\n\n/**\n * 建表\n */\nfunction _createTables(idb, tables) {\n    for (const tname in tables) {\n        const indexes = tables[tname] || { primary: '_id' };\n\n        if (!idb.objectStoreNames.contains(tname)) {\n            const tableIns = idb.createObjectStore(tname, { keyPath: indexes.primary });\n\n            if (indexes.unique) {\n                for (const uniqueKey of indexes.unique) {\n                    tableIns.createIndex(uniqueKey, uniqueKey, { unique: true });\n                }\n            }\n            if (indexes.index) {\n                for (const indexKey of indexes.unique) {\n                    tableIns.createIndex(indexKey, indexKey, { unique: false });\n                }\n            }\n        }\n    }\n}\n\nfunction _getStore(name, tname, permission) {\n    const transaction = dbPool[name].db.transaction(tname, permission);\n\n    return {\n        store: transaction.objectStore(tname),\n        transaction\n    };\n}\n\nfunction _getStoreCursor(name, tname, range) {\n    const transaction = dbPool[name].db.transaction(tname);\n    return transaction.objectStore(tname).openCursor(range, 'prev');\n}\n\nfunction _getIdxCursor(name, tname, iname, range) {\n    const transaction = dbPool[name].db.transaction(tname);\n    return transaction.objectStore(tname).index(iname).openCursor(range, 'prev');\n}\n\nfunction _cursorRange(filter) {\n    let lowerOpen = true, upperOpen = true;\n    let lower, upper;\n\n    if (_type(filter, 'object')) {\n        let range;\n\n        filter.$lte !== undefined && (upper = filter.$lte, upperOpen = false);\n        filter.$gte !== undefined && (lower = filter.$gte, lowerOpen = false);\n        upper === undefined && filter.$lt !== undefined && (upper = filter.$lt);\n        lower === undefined && filter.$gt !== undefined && (lower = filter.$gt);\n\n        if (lower !== undefined && upper === undefined) {\n            range = IDBKeyRange.lowerBound(lower, lowerOpen);\n        }\n        else if (upper !== undefined && lower === undefined) {\n            range = IDBKeyRange.upperBound(upper, upperOpen);\n        }\n        else if (lower !== undefined && upper !== undefined) {\n            range = IDBKeyRange.bound(lower, upper, lowerOpen, upperOpen);\n        }\n\n        delete filter.$lte;\n        delete filter.$gte;\n        delete filter.$lt;\n        delete filter.$gt;\n\n        return range;\n    }\n}\n\nfunction _addTask(name, functor) {\n    if (dbPool[name].db) {\n        functor();\n    }\n    else {\n        dbPool[name].reqQueue.push(functor);\n    }\n}\n\nfunction _find(search, opts, pickMany) {\n    const filters = _clone(search);\n    const filterKey = Object.keys(filters);\n    const { resolve, reject, promise } = _signal();\n\n    const request = () => {\n        const result = [];\n        const query = _getRangeQuery(filterKey, filters);\n        const cursor = _getCursor(this.database, this.collection, this.indexes, query);\n\n        cursor.onerror = reject;\n        cursor.onsuccess = () => {\n            const next = cursor.result;\n\n            if (next) {\n                result.push(next.value);\n\n                if (pickMany) {\n                    next.continue();\n                }\n                else {\n                    const matched = _filter(result, filterKey, filters, opts, pickMany);\n\n                    if (!matched) {\n                        return next.continue();\n                    }\n\n                    resolve(matched);\n                }\n            }\n            else {\n                if (pickMany) {\n                    resolve(_filter(result, filterKey, filters, opts, pickMany));\n                }\n                else {\n                    resolve(null);\n                }\n            }\n        };\n    };\n\n    _addTask(this.database, request);\n\n    return promise;\n}\n\nfunction _insert(name, tname, primary, data) {\n    const { resolve, reject, promise } = _signal();\n\n    const request = async () => {\n        const { store, transaction } = _getStore(name, tname, 'readwrite');\n        let nInserted = 0;\n\n        try {\n            if (_type(data, 'array')) {\n                const keys = [];\n\n                for (let i = data.length - 1; i >= 0; --i) {\n                    const item = data[i];\n\n                    if (item && !keys.includes(item[primary])) {\n                        if (_type(item.value, 'arraybuffer')) {\n                            await store.put(item.value, item[primary]);\n                        }\n                        else {\n                            await store.put(item, store.keyPath ? undefined : item[primary]);\n                        }\n\n                        keys.push(item[primary]);\n                        nInserted += 1;\n                    }\n                }\n            }\n            else if (_type(data, 'object')) {\n                if (_type(data.value, 'arraybuffer')) {\n                    await store.put(data.value, data[primary]);\n                }\n                else {\n                    await store.put(data, store.keyPath ? undefined : data[primary]);\n                }\n\n                nInserted += 1;\n            }\n\n            await transaction.complete;\n\n            resolve(new WriteResult(nInserted));\n        }\n        catch (err) { reject(err); }\n    };\n\n    _addTask(name, request);\n\n    return promise;\n}\n\nfunction _getCursor(name, tname, indexes, query) {\n    const { key, range } = query;\n    const { unique, index } = indexes;\n\n    if (range && (unique.includes(key) || index.includes(key))) {\n        return _getIdxCursor(name, tname, key, range);\n    }\n    else {\n        return _getStoreCursor(name, tname, range);\n    }\n}\n\nfunction _getRangeQuery(keys, filters) {\n    const query = {};\n\n    for (const key of keys) {\n        if (!key.includes('.')) {\n            const range = _cursorRange(filters[key]);\n\n            if (range) {\n                query.key = key;\n                query.range = range;\n\n                break;\n            }\n        }\n    }\n\n    return query;\n}\n\nfunction _filter(list, keys, search, opts, pickMany) {\n    const result = [];\n\n    for (const item of list) {\n        let matched = true;\n\n        for (const key of keys) {\n            const filter = search[key];\n            const field = _getField(item, key);\n\n            if (!_passPipe(field, filter)) {\n                matched = false;\n\n                break;\n            }\n        }\n\n        if (matched) {\n            result.push(item);\n        }\n    }\n\n    if (!pickMany) {\n        return result[0] || null;\n    }\n\n    return result;\n}\n\nfunction _passPipe(field, filter) {\n    let matched = Array.isArray(field) ? field : [field];\n\n    if (_type(field, 'array') && _type(filter, 'array')) {\n        return _eq(field, filter, true);\n    }\n\n    if (_odiType(filter)) {\n        matched = matched.filter(item => item === filter);\n    }\n    else if (_type(filter, 'regexp')) {\n        matched = matched.filter(item => filter.test(item));\n    }\n    else if (_hasProp(filter, '$eq')) {\n        matched = matched.filter(item => _eq(item, filter.$eq));\n    }\n    else if (_hasProp(filter, '$ne')) {\n        matched = matched.filter(item => !_eq(item, filter.$ne));\n    }\n    else if (_type(filter.$all, 'array')) {\n        matched = matched.filter(item => _eq(item, filter.$all, true));\n    }\n    else if (_type(filter.$in, 'array')) {\n        matched = matched.filter(item => filter.$in.includes(item));\n    }\n    else if (_type(filter.$nin, 'array')) {\n        matched = matched.filter(item => !filter.$nin.includes(item));\n    }\n\n    if (filter.$lte !== undefined) {\n        matched = matched.filter(item => item <= filter.$lte);\n    }\n    else if (filter.$lt !== undefined) {\n        matched = matched.filter(item => item < filter.$lt);\n    }\n\n    if (filter.$gte !== undefined) {\n        matched = matched.filter(item => item >= filter.$gte);\n    }\n    else if (filter.$gt !== undefined) {\n        matched = matched.filter(item => item > filter.$gt);\n    }\n\n    if (matched.length && _type(filter.$or, 'array')) {\n        const tempRes = new Set();\n\n        for (const subFilter of filter.$or) {\n            for (const subItem of matched) {\n                _passPipe(subItem, subFilter) && tempRes.add(subItem);\n            }\n        }\n\n        matched = [...tempRes];\n    }\n\n    return !!matched.length;\n}\n\nfunction _getField(target, path) {\n    if (target[path]) {\n        return target[path];\n    }\n\n    let result = target;\n    const paths = path.split('.');\n\n    try {\n        for (const subpath of paths) {\n            if (_type(result, 'array')) {\n                if (Number.isInteger(+subpath)) {\n                    result = result[subpath];\n                }\n                else {\n                    const match = result.filter(item => _hasProp(item, subpath)).map(item => item[subpath]);\n                    result = match.length ? match : undefined;\n                }\n            }\n            else if (_type(result, 'object')) {\n                result = result[subpath];\n            }\n            else {\n                return undefined;\n            }\n        }\n\n        return result;\n    }\n    catch (err) {/* None */ }\n}\n\nfunction WriteResult(num) {\n    this.__proto__ = null;\n    this.nInserted = num;\n}\n\nfunction RemoveResult(num) {\n    this.__proto__ = null;\n    this.nRemoved = num;\n}\n"],"names":["OkerNode","value","next","constructor","this","OkerQueue","_head","_tail","_size","clear","push","node","pop","current","undefined","size","Symbol","iterator","OkerLimit","concurrency","queue","activeCount","run","async","fn","resolve","args","result","generator","Promise","bind","enqueue","Object","defineProperties","get","pendingCount","clearQueue","toString","hasOwnProperty","prototype","_type","target","typ","call","toLowerCase","_hasProp","key","_eq","other","loosen","sort","JSON","stringify","_signal","reject","promise","r","e","fixedIOSbug","dbPool","insert","data","primary","indexes","name","tname","_addTask","store","transaction","_getStore","nInserted","keys","i","length","item","includes","put","keyPath","complete","WriteResult","err","_insert","database","collection","findById","_id","req","onsuccess","onerror","error","findOne","search","_find","find","opts","deleteOne","_delete","deleteMany","removeMany","matched","Array","isArray","delete","RemoveResult","permission","db","objectStore","_cursorRange","filter","lower","upper","lowerOpen","upperOpen","range","$lte","$gte","$lt","$gt","IDBKeyRange","lowerBound","upperBound","bound","functor","reqQueue","pickMany","filters","parse","_clone","filterKey","query","_getRangeQuery","cursor","unique","index","iname","openCursor","_getIdxCursor","_getStoreCursor","_getCursor","continue","_filter","list","_passPipe","_getField","field","test","$eq","$ne","$all","$in","$nin","$or","tempRes","Set","subFilter","subItem","add","path","paths","split","subpath","Number","isInteger","match","map","num","__proto__","nRemoved","version","tables","indexedDB","open","signalCtrl","limit","idbReq","getCollection","handlers","configurable","updateOne","updateMany","then","close","onupgradeneeded","idb","objectStoreNames","contains","tableIns","createObjectStore","uniqueKey","createIndex","indexKey","_createTables","request"],"mappings":"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"}