{"version":3,"file":"index.js","sources":["../node_modules/oker-limit/oker-queue.js","../node_modules/oker-limit/limit.js","../index.js"],"sourcesContent":["class OkerNode {\n\tvalue;\n\tnext;\n\n\tconstructor(value) {\n\t\tthis.value = value;\n\t}\n}\n\nexport class OkerQueue {\n\t_head;\n\t_tail;\n\t_size;\n\n\tconstructor() {\n\t\tthis.clear();\n\t}\n\n\tpush(value) {\n\t\tconst node = new OkerNode(value);\n\n\t\tif (this._head) {\n\t\t\tthis._tail.next = node;\n\t\t\tthis._tail = node;\n\t\t}\n        else {\n\t\t\tthis._head = node;\n\t\t\tthis._tail = node;\n\t\t}\n\n\t\tthis._size++;\n\t}\n\n\tpop() {\n\t\tconst current = this._head;\n\n\t\tif (!current) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._head = this._head.next;\n\t\tthis._size--;\n\t\treturn current.value;\n\t}\n\n\tclear() {\n\t\tthis._head = undefined;\n\t\tthis._tail = undefined;\n\t\tthis._size = 0;\n\t}\n\n\tget size() {\n\t\treturn this._size;\n\t}\n\n\t* [Symbol.iterator]() {\n\t\tlet current = this._head;\n\n\t\twhile (current) {\n\t\t\tyield current.value;\n\t\t\tcurrent = current.next;\n\t\t}\n\t}\n}\n","import { OkerQueue } from './oker-queue';\n\nexport function OkerLimit (concurrency) {\n\tconst queue = new OkerQueue();\n\tlet activeCount = 0;\n\n\tconst next = () => {\n\t\tactiveCount--;\n\n\t\tif (queue.size > 0) {\n\t\t\tqueue.pop()();\n\t\t}\n\t};\n\n\tconst run = async (fn, resolve, args) => {\n\t\tactiveCount++;\n\n\t\tconst result = (async () => fn(...args))();\n\n\t\tresolve(result);\n\n\t\ttry {\n\t\t\tawait result;\n\t\t} catch {}\n\n\t\tnext();\n\t};\n\n\tconst enqueue = (fn, resolve, args) => {\n\t\tqueue.push(run.bind(undefined, fn, resolve, args));\n\n\t\t(async () => {\n\t\t\tawait Promise.resolve();\n\n\t\t\tif (activeCount < concurrency && queue.size > 0) {\n\t\t\t\tqueue.pop()();\n\t\t\t}\n\t\t})();\n\t};\n\n\tconst generator = (fn, ...args) => new Promise(resolve => {\n\t\tenqueue(fn, resolve, args);\n\t});\n\n\tObject.defineProperties(generator, {\n\t\tactiveCount: {\n\t\t\tget: () => activeCount,\n\t\t},\n\t\tpendingCount: {\n\t\t\tget: () => queue.size,\n\t\t},\n\t\tclearQueue: {\n\t\t\tvalue: () => {\n\t\t\t\tqueue.clear();\n\t\t\t}\n\t\t},\n\t});\n\n\treturn generator;\n}\n","/**\n * @file iodb库\n * @date 2022-07-25\n * @author Perfumere\n */\n\nimport { OkerLimit } from 'oker-limit';\n\nconst { toString, hasOwnProperty } = Object.prototype;\n\nfunction _type(target, typ) {\n    return toString.call(target).toLowerCase() === `[object ${typ}]`;\n}\n\nfunction _odiType(target) {\n    return ['string', 'number', 'boolean', 'undefined'].includes(typeof target) || _type(target, 'null');\n}\n\nfunction _hasProp(target, key) {\n    return hasOwnProperty.call(target, key);\n}\n\nfunction _eq(target, other, loosen = false) {\n    if (loosen) {\n        _type(target, 'array') && target.sort();\n        _type(other, 'array') && other.sort();\n    }\n\n    return JSON.stringify(target) === JSON.stringify(other);\n}\n\nfunction _clone(target) {\n    try { return JSON.parse(JSON.stringify(target)); } catch (err) { return {}; }\n}\n\n/**\n * unwrap promise\n */\nfunction _signal() {\n    let resolve, reject;\n    const promise = new Promise((r, e) => (resolve = r, reject = e));\n\n    return { resolve, reject, promise };\n}\n\nlet fixedIOSbug = false;\nconst dbPool = {};\n\n/**\n * 获取indexedDB链接实例\n * @param opts.name 数据库名\n * @param opts.version 版本\n * @returns IDBDatabase\n */\nexport function connect(opts = { version: 1 }) {\n    const { name, tables, version = 1 } = opts;\n\n    if (!fixedIOSbug) {\n        /**\n         * [fix webkit bug](https://bugs.webkit.org/show_bug.cgi?id=226547)\n         */\n        indexedDB.open('__test', 1);\n        fixedIOSbug = true;\n    }\n\n    if (!dbPool[name] || !dbPool[name].promise) {\n        const signalCtrl = _signal();\n        const limit = OkerLimit(15);\n        const promise = signalCtrl.promise;\n        const idbReq = indexedDB.open(name, version);\n\n        dbPool[name] = { db: undefined, tables, reqQueue: [], promise };\n        promise.getCollection = (tname) => collection(name, tname);\n        promise.close = () => close(name);\n\n        idbReq.onupgradeneeded = () => _createTables(idbReq.result, tables);\n        idbReq.onsuccess = () => {\n            dbPool[name].db = idbReq.result;\n\n            // process cached request\n            for (const request of dbPool[name].reqQueue) {\n                try { limit(request); }\n                catch (err) { /* None */ }\n            }\n\n            dbPool[name].reqQueue = null;\n            signalCtrl.resolve({\n                getCollection: promise.getCollection,\n                close: () => promise.close\n            });\n        };\n        idbReq.onerror = () => signalCtrl.reject(idbReq.error);\n    }\n\n    return dbPool[name].promise;\n}\n\n/**\n * 获取指定表\n */\nfunction collection(name, tname) {\n    const signalCtrl = _signal();\n    const promise = signalCtrl.promise;\n    const { primary = '_id', unique = [], index = [] } = dbPool[name].tables[tname] || {};\n    const handlers = {\n        /** Props */\n        database: { value: name, configurable: false },\n        collection: { value: tname, configurable: false },\n        indexes: { value: { primary, unique, index }, configurable: false },\n        /** Methods */\n        findById: { value: findById, configurable: false },\n        findOne: { value: findOne, configurable: false },\n        find: { value: find, configurable: false },\n        deleteOne: { value: deleteOne, configurable: false },\n        deleteMany: { value: deleteMany, configurable: false },\n        updateOne: { value: insert, configurable: false },\n        updateMany: { value: insert, configurable: false }\n    };\n\n    Object.defineProperties(promise, handlers);\n\n    dbPool[name].promise.then(\n        () => signalCtrl.resolve(Object.defineProperties({ __proto__: null }, handlers))\n    );\n\n    return promise;\n}\n\n/**\n * 关闭指定数据库\n */\nfunction close(name) {\n    dbPool[name].promise.then(() => {\n        dbPool[name].db.close();\n        dbPool[name].reqQueue = null;\n        dbPool[name].db = undefined;\n\n        delete dbPool[name];\n    });\n}\n\n/**\n * 新增一条记录\n * @param tname 表名\n * @param data 数据\n */\nfunction insert(data) {\n    const { primary = '_id' } = this.indexes;\n    return _insert(this.database, this.collection, primary, data);\n}\n\nfunction findById(_id) {\n    const { resolve, reject, promise } = _signal();\n\n    const request = () => {\n        const req = _getStore(this.database, this.collection).store.get(_id);\n        req.onsuccess = () => resolve(req.result || null);\n        req.onerror = () => reject(req.error);\n    };\n\n    _addTask(this.database, request);\n\n    return promise;\n}\n\nfunction findOne(search) {\n    return _find.call(this, search, false);\n}\n\nfunction find(search) {\n    return _find.call(this, search, true);\n}\n\nfunction deleteOne(search) {\n    return _delete.call(this, search, false);\n}\n\nfunction deleteMany(search) {\n    return _delete.call(this, search, true);\n}\n\nfunction _delete(search, removeMany) {\n    const { promise, resolve, reject } = _signal();\n\n    const request = async () => {\n        let matched = await _find.call(this, search, removeMany);\n\n        if (!matched) {\n            resolve(new RemoveResult(0));\n        }\n        else {\n            matched = (Array.isArray(matched) ? matched : [matched]);\n\n            try {\n                const { store, transaction } = _getStore(this.database, this.collection, 'readwrite');\n\n                for (const item of matched) {\n                    await store.delete(item._id);\n                }\n\n                await transaction.complete;\n\n                resolve(new RemoveResult(matched.length));\n            }\n            catch (err) { reject(err); }\n        }\n    };\n\n    _addTask(this.database, request);\n\n    return promise;\n}\n\n/**\n * 建表\n */\nfunction _createTables(idb, tables) {\n    for (const tname in tables) {\n        const indexes = tables[tname] || { primary: '_id' };\n\n        if (!idb.objectStoreNames.contains(tname)) {\n            const tableIns = idb.createObjectStore(tname, { keyPath: indexes.primary });\n\n            if (indexes.unique) {\n                for (const uniqueKey of indexes.unique) {\n                    tableIns.createIndex(uniqueKey, uniqueKey, { unique: true });\n                }\n            }\n            if (indexes.index) {\n                for (const indexKey of indexes.unique) {\n                    tableIns.createIndex(indexKey, indexKey, { unique: false });\n                }\n            }\n        }\n    }\n}\n\nfunction _getStore(name, tname, permission) {\n    const transaction = dbPool[name].db.transaction(tname, permission);\n\n    return {\n        store: transaction.objectStore(tname),\n        transaction\n    };\n}\n\nfunction _getStoreCursor(name, tname, range) {\n    const transaction = dbPool[name].db.transaction(tname);\n    return transaction.objectStore(tname).openCursor(range, 'prev');\n}\n\nfunction _getIdxCursor(name, tname, iname, range) {\n    const transaction = dbPool[name].db.transaction(tname);\n    return transaction.objectStore(tname).index(iname).openCursor(range, 'prev');\n}\n\nfunction _cursorRange(filter) {\n    let lowerOpen = true, upperOpen = true;\n    let lower, upper;\n\n    if (_type(filter, 'object')) {\n        let range;\n\n        filter.$lte !== undefined && (upper = filter.$lte, upperOpen = false);\n        filter.$gte !== undefined && (lower = filter.$gte, lowerOpen = false);\n        upper === undefined && filter.$lt !== undefined && (upper = filter.$lt);\n        lower === undefined && filter.$gt !== undefined && (lower = filter.$gt);\n\n        if (lower !== undefined && upper === undefined) {\n            range = IDBKeyRange.lowerBound(lower, lowerOpen);\n        }\n        else if (upper !== undefined && lower === undefined) {\n            range = IDBKeyRange.upperBound(upper, upperOpen);\n        }\n        else if (lower !== undefined && upper !== undefined) {\n            range = IDBKeyRange.bound(lower, upper, lowerOpen, upperOpen);\n        }\n\n        delete filter.$lte;\n        delete filter.$gte;\n        delete filter.$lt;\n        delete filter.$gt;\n\n        return range;\n    }\n}\n\nfunction _addTask(name, functor) {\n    if (dbPool[name].db) {\n        functor();\n    }\n    else {\n        dbPool[name].reqQueue.push(functor);\n    }\n}\n\nfunction _find(search, pickMany) {\n    const filters = _clone(search);\n    const filterKey = Object.keys(filters);\n    const { resolve, reject, promise } = _signal();\n\n    const request = () => {\n        const result = [];\n        const query = _getRangeQuery(filterKey, filters);\n        const cursor = _getCursor(this.database, this.collection, this.indexes, query);\n\n        cursor.onerror = reject;\n        cursor.onsuccess = () => {\n            const next = cursor.result;\n\n            if (next) {\n                result.push(next.value);\n\n                if (pickMany) {\n                    next.continue();\n                }\n                else {\n                    const matched = _filter(result, filterKey, filters, pickMany);\n\n                    if (!matched) {\n                        return next.continue();\n                    }\n\n                    resolve(matched);\n                }\n            }\n            else {\n                if (pickMany) {\n                    resolve(_filter(result, filterKey, filters, pickMany));\n                }\n                else {\n                    resolve(null);\n                }\n            }\n        };\n    };\n\n    _addTask(this.database, request);\n\n    return promise;\n}\n\nfunction _insert(name, tname, primary, data) {\n    const { resolve, reject, promise } = _signal();\n\n    const request = async () => {\n        const { store, transaction } = _getStore(name, tname, 'readwrite');\n        let nInserted = 0;\n\n        try {\n            if (_type(data, 'array')) {\n                const keys = [];\n\n                for (let i = data.length - 1; i >= 0; --i) {\n                    const item = data[i];\n\n                    if (item && !keys.includes(item[primary])) {\n                        if (_type(item.value, 'arraybuffer')) {\n                            await store.put(item.value, item[primary]);\n                        }\n                        else {\n                            await store.put(_clone(item), store.keyPath ? undefined : item[primary]);\n                        }\n\n                        keys.push(item[primary]);\n                        nInserted += 1;\n                    }\n                }\n            }\n            else if (_type(data, 'object')) {\n                if (_type(data.value, 'arraybuffer')) {\n                    await store.put(data.value, data[primary]);\n                }\n                else {\n                    await store.put(_clone(data), store.keyPath ? undefined : data[primary]);\n                }\n\n                nInserted += 1;\n            }\n\n            await transaction.complete;\n\n            resolve(new WriteResult(nInserted));\n        }\n        catch (err) { reject(err); }\n    };\n\n    _addTask(name, request);\n\n    return promise;\n}\n\nfunction _getCursor(name, tname, indexes, query) {\n    const { key, range } = query;\n    const { unique, index } = indexes;\n\n    if (range && (unique.includes(key) || index.includes(key))) {\n        return _getIdxCursor(name, tname, key, range);\n    }\n    else {\n        return _getStoreCursor(name, tname, range);\n    }\n}\n\nfunction _getRangeQuery(keys, filters) {\n    const query = {};\n\n    for (const key of keys) {\n        if (!key.includes('.')) {\n            const range = _cursorRange(filters[key]);\n\n            if (range) {\n                query.key = key;\n                query.range = range;\n\n                break;\n            }\n        }\n    }\n\n    return query;\n}\n\nfunction _filter(list, keys, search, pickMany) {\n    const result = [];\n\n    for (const item of list) {\n        let matched = true;\n\n        for (const key of keys) {\n            const filter = search[key];\n            const field = _getField(item, key);\n\n            if (!_passPipe(field, filter)) {\n                matched = false;\n\n                break;\n            }\n        }\n\n        if (matched) {\n            result.push(item);\n        }\n    }\n\n    if (!pickMany) {\n        return result[0] || null;\n    }\n\n    return result;\n}\n\nfunction _passPipe(field, filter) {\n    let matched = Array.isArray(field) ? field : [field];\n\n    if (_type(field, 'array') && _type(filter, 'array')) {\n        return _eq(field, filter, true);\n    }\n\n    if (_odiType(filter)) {\n        matched = matched.filter(item => item === filter);\n    }\n    else if (_type(filter, 'regexp')) {\n        matched = matched.filter(item => filter.test(item));\n    }\n    else if (_hasProp(filter, '$eq')) {\n        matched = matched.filter(item => _eq(item, filter.$eq));\n    }\n    else if (_hasProp(filter, '$ne')) {\n        matched = matched.filter(item => !_eq(item, filter.$ne));\n    }\n    else if (_type(filter.$all, 'array')) {\n        matched = matched.filter(item => _eq(item, filter.$all, true));\n    }\n    else if (_type(filter.$in, 'array')) {\n        matched = matched.filter(item => filter.$in.includes(item));\n    }\n    else if (_type(filter.$nin, 'array')) {\n        matched = matched.filter(item => !filter.$nin.includes(item));\n    }\n\n    if (filter.$lte !== undefined) {\n        matched = matched.filter(item => item <= filter.$lte);\n    }\n    else if (filter.$lt !== undefined) {\n        matched = matched.filter(item => item < filter.$lt);\n    }\n\n    if (filter.$gte !== undefined) {\n        matched = matched.filter(item => item >= filter.$gte);\n    }\n    else if (filter.$gt !== undefined) {\n        matched = matched.filter(item => item > filter.$gt);\n    }\n\n    if (matched.length && _type(filter.$or, 'array')) {\n        const tempRes = new Set();\n\n        for (const subFilter of filter.$or) {\n            for (const subItem of matched) {\n                _passPipe(subItem, subFilter) && tempRes.add(subItem);\n            }\n        }\n\n        matched = [...tempRes];\n    }\n\n    return !!matched.length;\n}\n\nfunction _getField(target, path) {\n    if (target[path]) {\n        return target[path];\n    }\n\n    let result = target;\n    const paths = path.split('.');\n\n    try {\n        for (const subpath of paths) {\n            if (_type(result, 'array')) {\n                if (Number.isInteger(+subpath)) {\n                    result = result[subpath];\n                }\n                else {\n                    const match = result.filter(item => _hasProp(item, subpath)).map(item => item[subpath]);\n                    result = match.length ? match : undefined;\n                }\n            }\n            else if (_type(result, 'object')) {\n                result = result[subpath];\n            }\n            else {\n                return undefined;\n            }\n        }\n\n        return result;\n    }\n    catch (err) {/* None */ }\n}\n\nfunction WriteResult(num) {\n    this.__proto__ = null;\n    this.nInserted = num;\n}\n\nfunction RemoveResult(num) {\n    this.__proto__ = null;\n    this.nRemoved = num;\n}\n"],"names":["OkerNode","value","next","constructor","this","OkerQueue","_head","_tail","_size","clear","push","node","pop","current","undefined","size","Symbol","iterator","OkerLimit","concurrency","queue","activeCount","run","async","fn","resolve","args","result","generator","Promise","bind","enqueue","Object","defineProperties","get","pendingCount","clearQueue","toString","hasOwnProperty","prototype","_type","target","typ","call","toLowerCase","_hasProp","key","_eq","other","loosen","sort","JSON","stringify","_clone","parse","err","_signal","reject","promise","r","e","fixedIOSbug","dbPool","insert","data","primary","indexes","name","tname","_addTask","store","transaction","_getStore","nInserted","keys","i","length","item","includes","put","keyPath","complete","WriteResult","_insert","database","collection","findById","_id","req","onsuccess","onerror","error","findOne","search","_find","find","deleteOne","_delete","deleteMany","removeMany","matched","Array","isArray","delete","RemoveResult","permission","db","objectStore","_cursorRange","filter","lower","upper","lowerOpen","upperOpen","range","$lte","$gte","$lt","$gt","IDBKeyRange","lowerBound","upperBound","bound","functor","reqQueue","pickMany","filters","filterKey","query","_getRangeQuery","cursor","unique","index","iname","openCursor","_getIdxCursor","_getStoreCursor","_getCursor","continue","_filter","list","_passPipe","_getField","field","test","$eq","$ne","$all","$in","$nin","$or","tempRes","Set","subFilter","subItem","add","path","paths","split","subpath","Number","isInteger","match","map","num","__proto__","nRemoved","opts","version","tables","indexedDB","open","signalCtrl","limit","idbReq","getCollection","handlers","configurable","updateOne","updateMany","then","close","onupgradeneeded","idb","objectStoreNames","contains","tableIns","createObjectStore","uniqueKey","createIndex","indexKey","_createTables","request"],"mappings":"4OAAA,MAAMA,EACLC,MACAC,KAEAC,YAAYF,GACXG,KAAKH,MAAQA,CACb,EAGK,MAAMI,EACZC,MACAC,MACAC,MAEAL,cACCC,KAAKK,OACL,CAEDC,KAAKT,GACJ,MAAMU,EAAO,IAAIX,EAASC,GAEtBG,KAAKE,OACRF,KAAKG,MAAML,KAAOS,EAClBP,KAAKG,MAAQI,IAGbP,KAAKE,MAAQK,EACbP,KAAKG,MAAQI,GAGdP,KAAKI,OACL,CAEDI,MACC,MAAMC,EAAUT,KAAKE,MAErB,GAAKO,EAML,OAFAT,KAAKE,MAAQF,KAAKE,MAAMJ,KACxBE,KAAKI,QACEK,EAAQZ,KACf,CAEDQ,QACCL,KAAKE,WAAQQ,EACbV,KAAKG,WAAQO,EACbV,KAAKI,MAAQ,CACb,CAEGO,WACH,OAAOX,KAAKI,KACZ,CAED,EAAGQ,OAAOC,YACT,IAAIJ,EAAUT,KAAKE,MAEnB,KAAOO,SACAA,EAAQZ,MACdY,EAAUA,EAAQX,IAEnB,EC5DK,SAASgB,EAAWC,GAC1B,MAAMC,EAAQ,IAAIf,EAClB,IAAIgB,EAAc,EAElB,MAQMC,EAAMC,MAAOC,EAAIC,EAASC,KAC/BL,IAEA,MAAMM,EAAS,UAAaH,KAAME,GAAnB,GAEfD,EAAQE,GAER,UACOA,CACG,CAAR,MAAQ,CAhBVN,IAEID,EAAML,KAAO,GAChBK,EAAMR,KAANQ,EAeK,EAeDQ,EAAY,CAACJ,KAAOE,IAAS,IAAIG,SAAQJ,IAZ/B,EAACD,EAAIC,EAASC,KAC7BN,EAAMV,KAAKY,EAAIQ,UAAKhB,EAAWU,EAAIC,EAASC,IAE5C,iBACOG,QAAQJ,UAEVJ,EAAcF,GAAeC,EAAML,KAAO,GAC7CK,EAAMR,KAANQ,EAED,EAND,EAMI,EAIJW,CAAQP,EAAIC,EAASC,EAAK,IAiB3B,OAdAM,OAAOC,iBAAiBL,EAAW,CAClCP,YAAa,CACZa,IAAK,IAAMb,GAEZc,aAAc,CACbD,IAAK,IAAMd,EAAML,MAElBqB,WAAY,CACXnC,MAAO,KACNmB,EAAMX,OAAO,KAKTmB,CACR,CCnDA,MAAMS,SAAEA,EAAQC,eAAEA,GAAmBN,OAAOO,UAE5C,SAASC,EAAMC,EAAQC,GACnB,OAAOL,EAASM,KAAKF,GAAQG,gBAAkB,WAAWF,IAC9D,CAMA,SAASG,EAASJ,EAAQK,GACtB,OAAOR,EAAeK,KAAKF,EAAQK,EACvC,CAEA,SAASC,EAAIN,EAAQO,EAAOC,GAAS,GAMjC,OALIA,IACAT,EAAMC,EAAQ,UAAYA,EAAOS,OACjCV,EAAMQ,EAAO,UAAYA,EAAME,QAG5BC,KAAKC,UAAUX,KAAYU,KAAKC,UAAUJ,EACrD,CAEA,SAASK,EAAOZ,GACZ,IAAM,OAAOU,KAAKG,MAAMH,KAAKC,UAAUX,GAAsC,CAA1B,MAAOc,GAAO,MAAO,CAAE,CAAG,CACjF,CAKA,SAASC,IACL,IAAI/B,EAASgC,EACb,MAAMC,EAAU,IAAI7B,SAAQ,CAAC8B,EAAGC,KAAOnC,EAAUkC,EAAGF,EAASG,KAE7D,MAAO,CAAEnC,UAASgC,SAAQC,UAC9B,CAEA,IAAIG,GAAc,EAClB,MAAMC,EAAS,CAAA,EAoGf,SAASC,EAAOC,GACZ,MAAMC,QAAEA,EAAU,OAAU7D,KAAK8D,QACjC,OAkMJ,SAAiBC,EAAMC,EAAOH,EAASD,GACnC,MAAMvC,QAAEA,EAAOgC,OAAEA,EAAMC,QAAEA,GAAYF,IA8CrC,OAFAa,EAASF,GA1CO5C,UACZ,MAAM+C,MAAEA,EAAKC,YAAEA,GAAgBC,EAAUL,EAAMC,EAAO,aACtD,IAAIK,EAAY,EAEhB,IACI,GAAIjC,EAAMwB,EAAM,SAAU,CACtB,MAAMU,EAAO,GAEb,IAAK,IAAIC,EAAIX,EAAKY,OAAS,EAAGD,GAAK,IAAKA,EAAG,CACvC,MAAME,EAAOb,EAAKW,GAElB,GAAIE,IAASH,EAAKI,SAASD,EAAKZ,IAAW,CACvC,GAAIzB,EAAMqC,EAAK5E,MAAO,eAAgB,OAC5BqE,EAAMS,IAAIF,EAAK5E,MAAO4E,EAAKZ,GACpC,KACI,OACKK,EAAMS,IAAI1B,EAAOwB,GAAOP,EAAMU,QAAUlE,UAAY+D,EAAKZ,GAClE,CAEDS,EAAKhE,KAAKmE,EAAKZ,IACfQ,GAAa,CAChB,CACJ,CACJ,MACI,GAAIjC,EAAMwB,EAAM,UAAW,CAC5B,GAAIxB,EAAMwB,EAAK/D,MAAO,eAAgB,OAC5BqE,EAAMS,IAAIf,EAAK/D,MAAO+D,EAAKC,GACpC,KACI,OACKK,EAAMS,IAAI1B,EAAOW,GAAOM,EAAMU,QAAUlE,UAAYkD,EAAKC,GAClE,CAEDQ,GAAa,CAChB,OAEKF,EAAYU,SAElBxD,EAAQ,IAAIyD,EAAYT,GAEA,CAA5B,MAAOlB,GAAOE,EAAOF,EAAO,KAKzBG,CACX,CAlPWyB,CAAQ/E,KAAKgF,SAAUhF,KAAKiF,WAAYpB,EAASD,EAC5D,CAEA,SAASsB,EAASC,GACd,MAAM9D,QAAEA,EAAOgC,OAAEA,EAAMC,QAAEA,GAAYF,IAUrC,OAFAa,EAASjE,KAAKgF,UANE,KACZ,MAAMI,EAAMhB,EAAUpE,KAAKgF,SAAUhF,KAAKiF,YAAYf,MAAMpC,IAAIqD,GAChEC,EAAIC,UAAY,IAAMhE,EAAQ+D,EAAI7D,QAAU,MAC5C6D,EAAIE,QAAU,IAAMjC,EAAO+B,EAAIG,MAAM,IAKlCjC,CACX,CAEA,SAASkC,EAAQC,GACb,OAAOC,EAAMnD,KAAKvC,KAAMyF,GAAQ,EACpC,CAEA,SAASE,EAAKF,GACV,OAAOC,EAAMnD,KAAKvC,KAAMyF,GAAQ,EACpC,CAEA,SAASG,EAAUH,GACf,OAAOI,EAAQtD,KAAKvC,KAAMyF,GAAQ,EACtC,CAEA,SAASK,EAAWL,GAChB,OAAOI,EAAQtD,KAAKvC,KAAMyF,GAAQ,EACtC,CAEA,SAASI,EAAQJ,EAAQM,GACrB,MAAMzC,QAAEA,EAAOjC,QAAEA,EAAOgC,OAAEA,GAAWD,IA4BrC,OAFAa,EAASjE,KAAKgF,UAxBE7D,UACZ,IAAI6E,QAAgBN,EAAMnD,KAAKvC,KAAMyF,EAAQM,GAE7C,GAAKC,EAGA,CACDA,EAAWC,MAAMC,QAAQF,GAAWA,EAAU,CAACA,GAE/C,IACI,MAAM9B,MAAEA,EAAKC,YAAEA,GAAgBC,EAAUpE,KAAKgF,SAAUhF,KAAKiF,WAAY,aAEzE,IAAK,MAAMR,KAAQuB,QACT9B,EAAMiC,OAAO1B,EAAKU,WAGtBhB,EAAYU,SAElBxD,EAAQ,IAAI+E,EAAaJ,EAAQxB,QAET,CAA5B,MAAOrB,GAAOE,EAAOF,EAAO,CAC/B,MAjBG9B,EAAQ,IAAI+E,EAAa,GAiB5B,IAKE9C,CACX,CA0BA,SAASc,EAAUL,EAAMC,EAAOqC,GAC5B,MAAMlC,EAAcT,EAAOK,GAAMuC,GAAGnC,YAAYH,EAAOqC,GAEvD,MAAO,CACHnC,MAAOC,EAAYoC,YAAYvC,GAC/BG,cAER,CAYA,SAASqC,EAAaC,GAClB,IACIC,EAAOC,EADPC,GAAY,EAAMC,GAAY,EAGlC,GAAIzE,EAAMqE,EAAQ,UAAW,CACzB,IAAIK,EAsBJ,YApBgBpG,IAAhB+F,EAAOM,OAAuBJ,EAAQF,EAAOM,KAAMF,GAAY,QAC/CnG,IAAhB+F,EAAOO,OAAuBN,EAAQD,EAAOO,KAAMJ,GAAY,QACrDlG,IAAViG,QAAsCjG,IAAf+F,EAAOQ,MAAsBN,EAAQF,EAAOQ,UACzDvG,IAAVgG,QAAsChG,IAAf+F,EAAOS,MAAsBR,EAAQD,EAAOS,UAErDxG,IAAVgG,QAAiChG,IAAViG,EACvBG,EAAQK,YAAYC,WAAWV,EAAOE,QAEvBlG,IAAViG,QAAiCjG,IAAVgG,EAC5BI,EAAQK,YAAYE,WAAWV,EAAOE,QAEvBnG,IAAVgG,QAAiChG,IAAViG,IAC5BG,EAAQK,YAAYG,MAAMZ,EAAOC,EAAOC,EAAWC,WAGhDJ,EAAOM,YACPN,EAAOO,YACPP,EAAOQ,WACPR,EAAOS,IAEPJ,CACV,CACL,CAEA,SAAS7C,EAASF,EAAMwD,GAChB7D,EAAOK,GAAMuC,GACbiB,IAGA7D,EAAOK,GAAMyD,SAASlH,KAAKiH,EAEnC,CAEA,SAAS7B,EAAMD,EAAQgC,GACnB,MAAMC,EAAUzE,EAAOwC,GACjBkC,EAAY/F,OAAO0C,KAAKoD,IACxBrG,QAAEA,EAAOgC,OAAEA,EAAMC,QAAEA,GAAYF,IAwCrC,OAFAa,EAASjE,KAAKgF,UApCE,KACZ,MAAMzD,EAAS,GACTqG,EAqGd,SAAwBtD,EAAMoD,GAC1B,MAAME,EAAQ,CAAA,EAEd,IAAK,MAAMlF,KAAO4B,EACd,IAAK5B,EAAIgC,SAAS,KAAM,CACpB,MAAMoC,EAAQN,EAAakB,EAAQhF,IAEnC,GAAIoE,EAAO,CACPc,EAAMlF,IAAMA,EACZkF,EAAMd,MAAQA,EAEd,KACH,CACJ,CAGL,OAAOc,CACX,CAtHsBC,CAAeF,EAAWD,GAClCI,EAwFd,SAAoB/D,EAAMC,EAAOF,EAAS8D,GACtC,MAAMlF,IAAEA,EAAGoE,MAAEA,GAAUc,GACjBG,OAAEA,EAAMC,MAAEA,GAAUlE,EAE1B,OAAIgD,IAAUiB,EAAOrD,SAAShC,IAAQsF,EAAMtD,SAAShC,IAjJzD,SAAuBqB,EAAMC,EAAOiE,EAAOnB,GAEvC,OADoBpD,EAAOK,GAAMuC,GAAGnC,YAAYH,GAC7BuC,YAAYvC,GAAOgE,MAAMC,GAAOC,WAAWpB,EAAO,OACzE,CA+IeqB,CAAcpE,EAAMC,EAAOtB,EAAKoE,GAvJ/C,SAAyB/C,EAAMC,EAAO8C,GAElC,OADoBpD,EAAOK,GAAMuC,GAAGnC,YAAYH,GAC7BuC,YAAYvC,GAAOkE,WAAWpB,EAAO,OAC5D,CAuJesB,CAAgBrE,EAAMC,EAAO8C,EAE5C,CAlGuBuB,CAAWrI,KAAKgF,SAAUhF,KAAKiF,WAAYjF,KAAK8D,QAAS8D,GAExEE,EAAOxC,QAAUjC,EACjByE,EAAOzC,UAAY,KACf,MAAMvF,EAAOgI,EAAOvG,OAEpB,GAAIzB,EAGA,GAFAyB,EAAOjB,KAAKR,EAAKD,OAEb4H,EACA3H,EAAKwI,eAEJ,CACD,MAAMtC,EAAUuC,EAAQhH,EAAQoG,EAAWD,EAASD,GAEpD,IAAKzB,EACD,OAAOlG,EAAKwI,WAGhBjH,EAAQ2E,EACX,MAIG3E,EADAoG,EACQc,EAAQhH,EAAQoG,EAAWD,EAASD,GAGpC,KAEf,CACJ,IAKEnE,CACX,CAmFA,SAASiF,EAAQC,EAAMlE,EAAMmB,EAAQgC,GACjC,MAAMlG,EAAS,GAEf,IAAK,MAAMkD,KAAQ+D,EAAM,CACrB,IAAIxC,GAAU,EAEd,IAAK,MAAMtD,KAAO4B,EAAM,CACpB,MAAMmC,EAAShB,EAAO/C,GAGtB,IAAK+F,EAFSC,EAAUjE,EAAM/B,GAER+D,GAAS,CAC3BT,GAAU,EAEV,KACH,CACJ,CAEGA,GACAzE,EAAOjB,KAAKmE,EAEnB,CAED,OAAKgD,EAIElG,EAHIA,EAAO,IAAM,IAI5B,CAEA,SAASkH,EAAUE,EAAOlC,GACtB,IAAIT,EAAUC,MAAMC,QAAQyC,GAASA,EAAQ,CAACA,GAE9C,GAAIvG,EAAMuG,EAAO,UAAYvG,EAAMqE,EAAQ,SACvC,OAAO9D,EAAIgG,EAAOlC,GAAQ,GA1blC,IAAkBpE,EAied,GAheO,CAAC,SAAU,SAAU,UAAW,aAAaqC,gBADtCrC,EA6bDoE,KA5bkErE,EAAMC,EAAQ,QA6bzF2D,EAAUA,EAAQS,QAAOhC,GAAQA,IAASgC,IAErCrE,EAAMqE,EAAQ,UACnBT,EAAUA,EAAQS,QAAOhC,GAAQgC,EAAOmC,KAAKnE,KAExChC,EAASgE,EAAQ,OACtBT,EAAUA,EAAQS,QAAOhC,GAAQ9B,EAAI8B,EAAMgC,EAAOoC,OAE7CpG,EAASgE,EAAQ,OACtBT,EAAUA,EAAQS,QAAOhC,IAAS9B,EAAI8B,EAAMgC,EAAOqC,OAE9C1G,EAAMqE,EAAOsC,KAAM,SACxB/C,EAAUA,EAAQS,QAAOhC,GAAQ9B,EAAI8B,EAAMgC,EAAOsC,MAAM,KAEnD3G,EAAMqE,EAAOuC,IAAK,SACvBhD,EAAUA,EAAQS,QAAOhC,GAAQgC,EAAOuC,IAAItE,SAASD,KAEhDrC,EAAMqE,EAAOwC,KAAM,WACxBjD,EAAUA,EAAQS,QAAOhC,IAASgC,EAAOwC,KAAKvE,SAASD,WAGvC/D,IAAhB+F,EAAOM,KACPf,EAAUA,EAAQS,QAAOhC,GAAQA,GAAQgC,EAAOM,YAE5BrG,IAAf+F,EAAOQ,MACZjB,EAAUA,EAAQS,QAAOhC,GAAQA,EAAOgC,EAAOQ,YAG/BvG,IAAhB+F,EAAOO,KACPhB,EAAUA,EAAQS,QAAOhC,GAAQA,GAAQgC,EAAOO,YAE5BtG,IAAf+F,EAAOS,MACZlB,EAAUA,EAAQS,QAAOhC,GAAQA,EAAOgC,EAAOS,OAG/ClB,EAAQxB,QAAUpC,EAAMqE,EAAOyC,IAAK,SAAU,CAC9C,MAAMC,EAAU,IAAIC,IAEpB,IAAK,MAAMC,KAAa5C,EAAOyC,IAC3B,IAAK,MAAMI,KAAWtD,EAClByC,EAAUa,EAASD,IAAcF,EAAQI,IAAID,GAIrDtD,EAAU,IAAImD,EACjB,CAED,QAASnD,EAAQxB,MACrB,CAEA,SAASkE,EAAUrG,EAAQmH,GACvB,GAAInH,EAAOmH,GACP,OAAOnH,EAAOmH,GAGlB,IAAIjI,EAASc,EACb,MAAMoH,EAAQD,EAAKE,MAAM,KAEzB,IACI,IAAK,MAAMC,KAAWF,EAClB,GAAIrH,EAAMb,EAAQ,SACd,GAAIqI,OAAOC,WAAWF,GAClBpI,EAASA,EAAOoI,OAEf,CACD,MAAMG,EAAQvI,EAAOkF,QAAOhC,GAAQhC,EAASgC,EAAMkF,KAAUI,KAAItF,GAAQA,EAAKkF,KAC9EpI,EAASuI,EAAMtF,OAASsF,OAAQpJ,CACnC,KAEA,KAAI0B,EAAMb,EAAQ,UAInB,OAHAA,EAASA,EAAOoI,EAInB,CAGL,OAAOpI,CAEc,CAAzB,MAAO4B,GAAkB,CAC7B,CAEA,SAAS2B,EAAYkF,GACjBhK,KAAKiK,UAAY,KACjBjK,KAAKqE,UAAY2F,CACrB,CAEA,SAAS5D,EAAa4D,GAClBhK,KAAKiK,UAAY,KACjBjK,KAAKkK,SAAWF,CACpB,WAhfO,SAAiBG,EAAO,CAAEC,QAAS,IACtC,MAAMrG,KAAEA,EAAIsG,OAAEA,EAAMD,QAAEA,EAAU,GAAMD,EAUtC,GARK1G,IAID6G,UAAUC,KAAK,SAAU,GACzB9G,GAAc,IAGbC,EAAOK,KAAUL,EAAOK,GAAMT,QAAS,CACxC,MAAMkH,EAAapH,IACbqH,EAAQ3J,EAAU,IAClBwC,EAAUkH,EAAWlH,QACrBoH,EAASJ,UAAUC,KAAKxG,EAAMqG,GAEpC1G,EAAOK,GAAQ,CAAEuC,QAAI5F,EAAW2J,SAAQ7C,SAAU,GAAIlE,WACtDA,EAAQqH,cAAiB3G,GA4BjC,SAAoBD,EAAMC,GACtB,MAAMwG,EAAapH,IACbE,EAAUkH,EAAWlH,SACrBO,QAAEA,EAAU,MAAKkE,OAAEA,EAAS,GAAEC,MAAEA,EAAQ,IAAOtE,EAAOK,GAAMsG,OAAOrG,IAAU,CAAA,EAC7E4G,EAAW,CAEb5F,SAAU,CAAEnF,MAAOkE,EAAM8G,cAAc,GACvC5F,WAAY,CAAEpF,MAAOmE,EAAO6G,cAAc,GAC1C/G,QAAS,CAAEjE,MAAO,CAAEgE,UAASkE,SAAQC,SAAS6C,cAAc,GAE5D3F,SAAU,CAAErF,MAAOqF,EAAU2F,cAAc,GAC3CrF,QAAS,CAAE3F,MAAO2F,EAASqF,cAAc,GACzClF,KAAM,CAAE9F,MAAO8F,EAAMkF,cAAc,GACnCjF,UAAW,CAAE/F,MAAO+F,EAAWiF,cAAc,GAC7C/E,WAAY,CAAEjG,MAAOiG,EAAY+E,cAAc,GAC/CC,UAAW,CAAEjL,MAAO8D,EAAQkH,cAAc,GAC1CE,WAAY,CAAElL,MAAO8D,EAAQkH,cAAc,IAS/C,OANAjJ,OAAOC,iBAAiByB,EAASsH,GAEjClH,EAAOK,GAAMT,QAAQ0H,MACjB,IAAMR,EAAWnJ,QAAQO,OAAOC,iBAAiB,CAAEoI,UAAW,MAAQW,MAGnEtH,CACX,CAtD2C2B,CAAWlB,EAAMC,GACpDV,EAAQ2H,MAAQ,IA0DxB,SAAelH,GACXL,EAAOK,GAAMT,QAAQ0H,MAAK,KACtBtH,EAAOK,GAAMuC,GAAG2E,QAChBvH,EAAOK,GAAMyD,SAAW,KACxB9D,EAAOK,GAAMuC,QAAK5F,SAEXgD,EAAOK,EAAK,GAE3B,CAlE8BkH,CAAMlH,GAE5B2G,EAAOQ,gBAAkB,IA6IjC,SAAuBC,EAAKd,GACxB,IAAK,MAAMrG,KAASqG,EAAQ,CACxB,MAAMvG,EAAUuG,EAAOrG,IAAU,CAAEH,QAAS,OAE5C,IAAKsH,EAAIC,iBAAiBC,SAASrH,GAAQ,CACvC,MAAMsH,EAAWH,EAAII,kBAAkBvH,EAAO,CAAEY,QAASd,EAAQD,UAEjE,GAAIC,EAAQiE,OACR,IAAK,MAAMyD,KAAa1H,EAAQiE,OAC5BuD,EAASG,YAAYD,EAAWA,EAAW,CAAEzD,QAAQ,IAG7D,GAAIjE,EAAQkE,MACR,IAAK,MAAM0D,KAAY5H,EAAQiE,OAC3BuD,EAASG,YAAYC,EAAUA,EAAU,CAAE3D,QAAQ,GAG9D,CACJ,CACL,CAhKuC4D,CAAcjB,EAAOnJ,OAAQ8I,GAC5DK,EAAOrF,UAAY,KACf3B,EAAOK,GAAMuC,GAAKoE,EAAOnJ,OAGzB,IAAK,MAAMqK,KAAWlI,EAAOK,GAAMyD,SAC/B,IAAMiD,EAAMmB,EACc,CAA1B,MAAOzI,GAAmB,CAG9BO,EAAOK,GAAMyD,SAAW,KACxBgD,EAAWnJ,QAAQ,CACfsJ,cAAerH,EAAQqH,cACvBM,MAAO,IAAM3H,EAAQ2H,OACvB,EAENP,EAAOpF,QAAU,IAAMkF,EAAWnH,OAAOqH,EAAOnF,MACnD,CAED,OAAO7B,EAAOK,GAAMT,OACxB"}